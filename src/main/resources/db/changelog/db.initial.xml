<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">
    <changeSet id="20190602-1" author="pdubs">
        <createTable tableName="user">
            <column name="id" autoIncrement="true" type="INTEGER">
                <constraints primaryKey="true" />
            </column>
            <column name="email" type="VARCHAR(255)" />
            <column name="password" type="VARCHAR(60)"/>
        </createTable>
        <createTable tableName="project">
            <column name="id" autoIncrement="true" type="INTEGER">
                <constraints primaryKey="true" />
            </column>
            <column name="userId" type="INTEGER">
                <constraints references="user" referencedColumnNames="id" foreignKeyName="project_owner" />
            </column>
            <column name="name" type="NVARCHAR"/>
            <column name="createdAt" type="DATETIME" valueComputed="NOW()"/>
            <column name="updatedAt" type="DATETIME" valueComputed="NOW()"/>
        </createTable>
        <createTable tableName="model">
            <column name="id" autoIncrement="true" type="INTEGER">
                <constraints primaryKey="true" />
            </column>
            <column name="userId" type="INTEGER">
                <constraints referencedColumnNames="id" references="user" foreignKeyName="model_owner"/>
            </column>
            <column name="name" type="NVARCHAR"/>
            <column name="fileId" type="VARCHAR" remarks="This is the file id as returned by rescale api"/>
            <column name="createdAt" type="DATETIME" valueComputed="NOW()"/>
        </createTable>
        <createTable tableName="mdp">
            <column name="id" autoIncrement="true" type="INTEGER">
                <constraints primaryKey="true" />
            </column>
            <column name="userId" type="INTEGER">
                <constraints referencedColumnNames="id" references="user" foreignKeyName="mdp_owner"/>
            </column>
            <column name="modelId" type="INTEGER">
                <constraints referencedColumnNames="id" references="model" foreignKeyName="mdp_for_model"/>
            </column>
            <column name="name" type="NVARCHAR"/>
            <column name="code" type="NVARCHAR" />
            <column name="verified" type="BOOLEAN" defaultValueBoolean="false" />
            <column name="createdAt" type="DATETIME" valueComputed="NOW()"/>
            <column name="updatedAt" type="DATETIME" valueComputed="NOW()"/>
        </createTable>
        <createTable tableName="run">
            <column name="id" autoIncrement="true" type="INTEGER">
                <constraints primaryKey="true" />
            </column>
            <column name="userId" type="INTEGER">
                <constraints referencedColumnNames="id" references="user" foreignKeyName="run_owner"/>
            </column>
            <column name="modelId" type="INTEGER">
                <constraints referencedColumnNames="id" references="model" foreignKeyName="run_model"/>
            </column>
            <column name="mdpId" type="INTEGER">
                <constraints referencedColumnNames="id" references="mdp" foreignKeyName="run_mdp"/>
            </column>
            <column name="startedAt" type="DATETIME" valueComputed="NOW()"/>
            <column name="finishedAt" type="DATETIME">
                <constraints nullable="true" />
            </column>
            <column name="status" type="NVARCHAR" />
        </createTable>
        <createTable tableName="policy">
            <column name="id" autoIncrement="true" type="INTEGER">
                <constraints primaryKey="true" />
            </column>
            <column name="userId" type="INTEGER">
                <constraints referencedColumnNames="id" references="user" foreignKeyName="policyOwner"/>
            </column>
            <column name="modelId" type="INTEGER">
                <constraints referencedColumnNames="id" references="model" foreignKeyName="policy_model"/>
            </column>
            <column name="mdpId" type="INTEGER">
                <constraints referencedColumnNames="id" references="mdp" foreignKeyName="policy_mdp"/>
            </column>
            <column name="runId" type="INTEGER">
                <constraints referencedColumnNames="id" references="run" foreignKeyName="policy_created_by_run"/>
            </column>
            <column name="createdAt" type="DATETIME" valueComputed="NOW()"/>
            <column name="fileId" type="VARCHAR" remarks="This is the file id as returned by rescale api"/>
        </createTable>
    </changeSet>
    <changeSet id="20190602-2" author="pdubs">
        <addUniqueConstraint tableName="user" columnNames="email" />
    </changeSet>
</databaseChangeLog>